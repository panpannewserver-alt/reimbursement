<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Employee Reimbursement Portal</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<!-- pdf-lib -->
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

<style>
:root{
  --asi-red:#C31D2C;
  --asi-red-dark:#A91824;
  --asi-charcoal:#2B2F33;
  --asi-slate:#3E464D;
  --asi-bg:#F5F7FA;
  --asi-border:#E6EAF0;
  --asi-focus:rgba(195,29,44,.25);
}
body{
  background:
    radial-gradient(1000px 500px at 10% -10%, rgba(195,29,44,.10), transparent 60%),
    radial-gradient(900px 500px at 110% 0%, rgba(43,47,51,.08), transparent 55%),
    var(--asi-bg);
  color:var(--asi-charcoal);
}
.container{max-width:980px}
.asi-header{background:#fff;border-bottom:1px solid var(--asi-border)}
.asi-brand{display:flex;align-items:center;gap:.75rem;padding:1rem 0}
.asi-logo{height:36px}
.asi-title{margin:0;font-weight:700;font-size:1.1rem}
.asi-subtitle{margin:0;font-size:.85rem;color:var(--asi-slate)}
.asi-card{
  background:#fff;
  border:1px solid var(--asi-border);
  border-radius:14px;
  box-shadow:0 10px 25px rgba(0,0,0,.05);
}
.asi-card-header{
  padding:1rem 1.25rem;
  border-bottom:1px solid var(--asi-border);
  background:linear-gradient(90deg, rgba(195,29,44,.08), transparent);
}
.asi-card-body{padding:1.25rem}
.form-label{font-weight:600;color:var(--asi-slate)}
.form-control{border-radius:10px;border-color:var(--asi-border)}
.form-control:focus{border-color:var(--asi-red);box-shadow:0 0 0 .25rem var(--asi-focus)}
.btn-asi-primary{
  background:var(--asi-red);
  color:#fff;
  font-weight:800;
  border-radius:10px;
}
.btn-asi-primary:hover{background:var(--asi-red-dark)}
.table-wrap{border:1px solid var(--asi-border);border-radius:14px;overflow:hidden;background:#fff}
.table thead th{background:rgba(195,29,44,.08);font-weight:800}
.total-row{
  background:#fff3f4;
  font-weight:900;
}
.total-row td{border-top:2px solid var(--asi-red)}
</style>
</head>

<body>

<!-- HEADER -->
<div class="asi-header">
  <div class="container">
    <div class="asi-brand">
      <img src="https://alliancesi.com.au/wp-content/uploads/2021/06/alliancesi-logo.png"
           class="asi-logo"
           alt="Alliance SI logo">
      <div>
        <p class="asi-title">Employee Reimbursement Portal</p>
        <p class="asi-subtitle">Submit expenses & generate merged PDF</p>
      </div>
      <span class="ms-auto badge bg-light border">AUD</span>
    </div>
  </div>
</div>

<div class="container my-4">

<!-- EMPLOYEE DETAILS -->
<div class="asi-card mb-4">
  <div class="asi-card-header"><h2>Employee Details</h2></div>
  <div class="asi-card-body">
    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label">Employee Name</label>
        <input type="text" class="form-control" id="empName" required>
      </div>
      <div class="col-md-4">
        <label class="form-label">Employee Email</label>
        <input type="email" class="form-control" id="empEmail" required>
      </div>
      <div class="col-md-4">
        <label class="form-label">Payment Method</label>
        <select class="form-control" id="paymentMethod" onchange="toggleBankFields()">
          <option value="payroll">Payroll Account</option>
          <option value="bank">Alternate Bank Account</option>
        </select>
      </div>

      <div class="col-md-2" id="bsbGroup" style="display:none;">
        <label class="form-label">BSB</label>
        <input type="text" class="form-control" id="bsb">
      </div>
      <div class="col-md-2" id="accountGroup" style="display:none;">
        <label class="form-label">Account Number</label>
        <input type="text" class="form-control" id="accountNumber">
      </div>
    </div>
  </div>
</div>

<!-- APPROVER DETAILS -->
<div class="asi-card mb-4">
  <div class="asi-card-header"><h2>Approver Details</h2></div>
  <div class="asi-card-body">
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Approver Name</label>
        <input type="text" class="form-control" id="approverName">
      </div>
      <div class="col-md-6">
        <label class="form-label">Approver Email</label>
        <input type="email" class="form-control" id="approverEmail">
      </div>
    </div>
  </div>
</div>

<!-- EXPENSE ENTRY -->
<div class="asi-card mb-4">
  <div class="asi-card-header"><h2>Expense Entry</h2></div>
  <div class="asi-card-body">
    <form id="expenseForm">
      <div class="row g-3">
        <div class="col-md-2">
          <label class="form-label">Date</label>
          <input type="date" class="form-control" id="date" required>
        </div>
        <div class="col-md-2">
          <label class="form-label">Job / PO</label>
          <input type="text" class="form-control" id="job">
        </div>
        <div class="col-md-2">
          <label class="form-label">Total (GST incl.)</label>
          <input type="number" class="form-control" id="amount" step="0.01" required oninput="calculateGST()">
        </div>
        <div class="col-md-2">
          <label class="form-label">GST</label>
          <input type="number" class="form-control" id="gst" readonly>
        </div>
        <div class="col-md-4">
          <label class="form-label">Receipts</label>
          <input type="file" class="form-control" id="files" multiple accept="image/*,application/pdf">
        </div>

        <div class="col-12">
          <label class="form-label">Purpose / Description</label>
          <input type="text class="form-control" id="description" required>
        </div>
      </div>

      <div class="mt-4">
        <button type="button" class="btn btn-asi-primary" onclick="addExpense()">âž• Add Expense Line</button>
        <span class="ms-3 text-muted" id="expenseCount">0 expense(s) added</span>
      </div>
    </form>
  </div>
</div>

<!-- PREVIEW -->
<div class="asi-card">
  <div class="asi-card-header d-flex justify-content-between align-items-center">
    <h2 class="mb-0">Expense Preview</h2>
    <button type="button" class="btn btn-asi-primary" onclick="generateMergedPDF()">Generate Merged PDF</button>
  </div>

  <div class="asi-card-body">
    <div class="table-wrap">
      <table class="table table-bordered mb-0" id="expenseTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Job / PO</th>
            <th>Description</th>
            <th>GST (AUD)</th>
            <th>Total (AUD)</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr class="total-row">
            <td colspan="5" class="text-end">TOTAL REIMBURSEMENT (AUD)</td>
            <td class="text-end" id="grandTotal">0.00</td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
</div>

</div>

<script>
const expenses = [];
let attachedFiles = [];

function formatMoney(v){ return Number(v || 0).toFixed(2); }

function calculateGST(){
  gst.value = formatMoney(Number(amount.value || 0) / 11);
}

function toggleBankFields(){
  const show = paymentMethod.value === 'bank';
  bsbGroup.style.display = show ? 'block' : 'none';
  accountGroup.style.display = show ? 'block' : 'none';
}

function updateTotals(){
  let total = 0;
  expenses.forEach(function(e){ total += Number(e.amount || 0); });
  grandTotal.textContent = formatMoney(total);
  expenseCount.textContent = expenses.length + ' expense(s) added';
}

function renderTable(){
  const tbody = expenseTable.querySelector('tbody');
  tbody.innerHTML = '';

  expenses.forEach(function(e, i){
    const r = tbody.insertRow();
    r.innerHTML =
      '<td>'+e.date+'</td>'+
      '<td>'+e.job+'</td>'+
      '<td>'+e.desc+'</td>'+
      '<td class="text-end">'+e.gst+'</td>'+
      '<td class="text-end">'+e.amount+'</td>'+
      '<td><button class="btn btn-outline-danger btn-sm" onclick="removeExpense('+i+')">Remove</button></td>';
  });
}

function addExpense(){
  if(!date.value || !description.value || !amount.value){
    alert('Complete required fields.');
    return;
  }

  if(files.files.length){
    attachedFiles = Array.from(files.files);
  }

  expenses.push({
    date: date.value,
    job: job.value || '-',
    desc: description.value,
    gst: formatMoney(gst.value),
    amount: formatMoney(amount.value)
  });

  expenseForm.reset();
  renderTable();
  updateTotals();
}

function removeExpense(index){
  expenses.splice(index, 1);
  renderTable();
  updateTotals();
}

/* ===== Make Generate PDF button always work ===== */
async function generateMergedPDF(){
  if(!expenses.length){
    alert('Add at least one expense.');
    return;
  }

  // Safely get jsPDF
  const jsPDFRef = window.jspdf && window.jspdf.jsPDF ? window.jspdf.jsPDF : (window.jsPDF || null);
  if(!jsPDFRef){
    alert('PDF library failed to load. Please refresh.');
    return;
  }

  const summary = new jsPDFRef();
  summary.setFontSize(16);
  summary.text('Employee Reimbursement Claim', 14, 18);

  summary.setFontSize(10);
  summary.text('Employee: ' + (empName.value || ''), 14, 26);
  summary.text('Email: ' + (empEmail.value || ''), 14, 32);
  summary.text('Submitted: ' + new Date().toLocaleString(), 14, 38);

  try{
    summary.autoTable({
      startY: 48,
      head: [['Date','Job / PO','Description','GST (AUD)','Total (AUD)']],
      body: expenses.map(function(e){ return [e.date,e.job,e.desc,e.gst,e.amount]; }),
      styles:{fontSize:10},
      headStyles:{fillColor:[195,29,44]}
    });
  }catch(err){
    console.error('autoTable failed', err);
    // Continue anyway
  }

  const totalY = summary.lastAutoTable && summary.lastAutoTable.finalY ? summary.lastAutoTable.finalY + 10 : 48 + 10;
  summary.setFontSize(11);
  summary.text('TOTAL REIMBURSEMENT (AUD): ' + grandTotal.textContent, 14, totalY);

  // Try full merge with pdf-lib. If it fails, just download summary.
  try{
    if(!window.PDFLib || !window.PDFLib.PDFDocument){
      throw new Error('pdf-lib not available');
    }

    const PDFDocument = window.PDFLib.PDFDocument;
    const summaryBytes = summary.output('arraybuffer');
    const finalPdf = await PDFDocument.load(summaryBytes);

    for(const file of attachedFiles){
      const bytes = await file.arrayBuffer();

      if(file.type === 'application/pdf'){
        const pdf = await PDFDocument.load(bytes);
        const pages = await finalPdf.copyPages(pdf, pdf.getPageIndices());
        pages.forEach(function(p){ finalPdf.addPage(p); });
      } else if(file.type.indexOf('image/') === 0){
        const imgDoc = await PDFDocument.create();
        const page = imgDoc.addPage([595,842]);

        let img;
        if(file.type.indexOf('png') > -1){
          img = await imgDoc.embedPng(bytes);
        } else {
          img = await imgDoc.embedJpg(bytes);
        }

        const dims = img.scaleToFit(550,780);
        page.drawImage(img,{x:22,y:30,width:dims.width,height:dims.height});

        const copied = await finalPdf.copyPages(imgDoc,[0]);
        finalPdf.addPage(copied[0]);
      }
    }

    const out = await finalPdf.save();
    const blob = new Blob([out], {type:'application/pdf'});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'reimbursement_claim_merged.pdf';
    link.click();
  }catch(err){
    console.error('Merge failed, downloading summary only', err);
    const blob = summary.output('blob');
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'reimbursement_claim.pdf';
    link.click();
  }
}

updateTotals();
</script>

</body>
</html>
